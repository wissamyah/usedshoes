import{u as V,d as $,r as g,j as e,X as R,b as q}from"./index-DPf7JDXQ.js";import{M}from"./Modal-CEl-WYAK.js";function L({container:c,onSubmit:Q,onCancel:S}){const{products:b,updateProduct:A}=V(),{showErrorMessage:k}=$(),[t,h]=g.useState({id:"",supplier:"",invoiceNumber:"",purchaseDate:new Date().toISOString().split("T")[0],shippingCost:"0",customsCost:"0",description:"",products:[]}),[u,N]=g.useState({}),[v,I]=g.useState(!1),[i,D]=g.useState(""),[l,F]=g.useState({bagQuantity:"",costPerKg:"",bagWeight:"25"});g.useEffect(()=>{c&&h({id:c.id||"",supplier:c.supplier||"",invoiceNumber:c.invoiceNumber||"",purchaseDate:c.purchaseDate||new Date().toISOString().split("T")[0],shippingCost:c.shippingCost?.toString()||"0",customsCost:c.customsCost?.toString()||"0",description:c.description||"",products:c.products||[]})},[c]),g.useEffect(()=>{console.log("formData.products updated:",t.products)},[t.products]);const m=s=>{const{name:r,value:o}=s.target;h(a=>({...a,[r]:o})),u[r]&&N(a=>({...a,[r]:""}))},P=s=>{const{name:r,value:o}=s.target;F(a=>({...a,[r]:o}))},T=()=>{if(console.log("Adding product to container:",{selectedProduct:i,productPurchase:l,formData:t.products,isProductsArray:Array.isArray(t.products),formDataType:typeof t,fullFormData:t}),!i||!l.bagQuantity||!l.costPerKg){k("Incomplete Product Details","Please select a product and fill in all purchase details");return}if(!Array.isArray(t.products)){console.error("formData.products is not an array!",t.products),h(o=>({...o,products:[]}));return}const s=b.find(o=>o.id==i||o.id===parseInt(i)||o.id===i.toString());if(console.log("Looking for product with ID:",i),console.log("Available products:",b.map(o=>({id:o.id,idType:typeof o.id,name:o.name}))),console.log("selectedProduct type:",typeof i),console.log("Found product:",s),!s){console.error("Product not found! Selected ID:",i,"Available products:",b.map(o=>({id:o.id,name:o.name}))),k("Product Not Found","Selected product not found. Please try again.");return}const r=t.products.findIndex(o=>o.productId==i||o.productId===parseInt(i)||o.productId===i.toString());if(r>=0)console.log("Updating existing product at index:",r),h(o=>{const a=o.products.map((n,d)=>d===r?{...n,bagQuantity:parseInt(l.bagQuantity),costPerKg:parseFloat(l.costPerKg),bagWeight:parseFloat(l.bagWeight)}:n);return console.log("Updated existing product, new products array:",a),{...o,products:a}});else{const o={productId:i,productName:s.name,bagQuantity:parseInt(l.bagQuantity),costPerKg:parseFloat(l.costPerKg),bagWeight:parseFloat(l.bagWeight)};console.log("Creating new product:",o),console.log("Current products before adding:",t.products);const a=[...t.products,o];console.log("Updated products array:",a),h(n=>{const d={...n,products:a};return console.log("Setting new form data:",d),d})}D(""),F({bagQuantity:"",costPerKg:"",bagWeight:"25"}),console.log("Product added successfully. Updated formData:",t.products)},U=s=>{h(r=>({...r,products:r.products.filter(o=>o.productId!==s)}))},K=()=>{const s=t.products.reduce((a,n)=>a+n.bagQuantity*n.costPerKg*n.bagWeight,0),r=parseFloat(t.shippingCost)||0,o=parseFloat(t.customsCost)||0;return s+r+o},E=(s,r,o,a,n,d=0)=>{const y=s*n,j=o*n,f=y+j;if(f===0)return a;const p=y*r,C=j*a+o*d;return(p+C)/f},B=async s=>{if(s.preventDefault(),console.log("Submitting container form:",{id:t.id,supplier:t.supplier,productsCount:t.products.length,products:t.products}),!t.id||!t.supplier||t.products.length===0){const r={id:t.id?"":"Container ID is required",supplier:t.supplier?"":"Supplier is required",products:t.products.length===0?"At least one product is required":""};console.log("Validation failed:",r),N(r);return}I(!0);try{const r=K(),o={...t,shippingCost:parseFloat(t.shippingCost)||0,customsCost:parseFloat(t.customsCost)||0,totalCost:r};if(c)console.log("EDITING CONTAINER: Skipping manual product stock updates - DataContext handles this");else{console.log("NEW CONTAINER: Updating product stocks for container products:",t.products);for(const a of t.products){console.log("Processing container product:",a);const n=b.find(d=>d.id==a.productId||d.id===parseInt(a.productId)||d.id===a.productId.toString());if(console.log("Found product for update:",n),n){const d=t.products.reduce((w,O)=>w+O.bagQuantity,0),y=parseFloat(t.shippingCost)||0,j=parseFloat(t.customsCost)||0,f=d>0?(y+j)/d:0;let p;n.currentStock===0?p=(a.costPerKg*a.bagWeight+f)/a.bagWeight:p=E(n.currentStock,n.costPerKg||n.costPerUnit||0,a.bagQuantity,a.costPerKg,a.bagWeight,f);const C={...n,currentStock:n.currentStock+a.bagQuantity,costPerKg:p,costPerUnit:p,bagWeight:a.bagWeight};console.log("Updating product:",{productId:n.id,oldStock:n.currentStock,addedBags:a.bagQuantity,newStock:C.currentStock,oldCost:n.costPerKg||n.costPerUnit||0,newCost:p}),await A(n.id,C),console.log("Product updated successfully")}else console.error("Product not found for ID:",a.productId,"Available products:",b.map(d=>({id:d.id,name:d.name})))}}await Q(o)}catch(r){console.error("Form submission error:",r),N({submit:"Failed to save container"})}finally{I(!1)}},W=()=>{S()},x=(s,r=2)=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:r,maximumFractionDigits:r}).format(s||0);return e.jsx(M,{isOpen:!0,onClose:S,size:"large",children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl p-5 max-h-[80vh] overflow-y-auto",children:e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:c?"Edit Container":"Add New Container"}),e.jsxs("button",{onClick:W,className:"text-gray-400 hover:text-gray-600",children:[e.jsx("span",{className:"sr-only",children:"Close"}),e.jsx(R,{className:"h-6 w-6"})]})]}),e.jsxs("form",{onSubmit:B,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"id",className:"block text-sm font-medium text-gray-700",children:"Container ID *"}),e.jsx("input",{type:"text",id:"id",name:"id",value:t.id,onChange:m,className:`mt-1 block w-full border rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 ${u.id?"border-red-300 focus:border-red-500":"border-gray-300 focus:border-blue-500"}`,placeholder:"Container ID"}),u.id&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:u.id})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"supplier",className:"block text-sm font-medium text-gray-700",children:"Supplier *"}),e.jsx("input",{type:"text",id:"supplier",name:"supplier",value:t.supplier,onChange:m,className:`mt-1 block w-full border rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 ${u.supplier?"border-red-300 focus:border-red-500":"border-gray-300 focus:border-blue-500"}`,placeholder:"Supplier"}),u.supplier&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:u.supplier})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"invoiceNumber",className:"block text-sm font-medium text-gray-700",children:"Invoice Number"}),e.jsx("input",{type:"text",id:"invoiceNumber",name:"invoiceNumber",value:t.invoiceNumber,onChange:m,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Invoice #"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"purchaseDate",className:"block text-sm font-medium text-gray-700",children:"Purchase Date *"}),e.jsx("input",{type:"date",id:"purchaseDate",name:"purchaseDate",value:t.purchaseDate,onChange:m,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"shippingCost",className:"block text-sm font-medium text-gray-700",children:"Shipping Cost ($)"}),e.jsx("input",{type:"number",id:"shippingCost",name:"shippingCost",value:t.shippingCost,onChange:m,min:"0",step:"0.01",className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"customsCost",className:"block text-sm font-medium text-gray-700",children:"Customs/Clearing Cost ($)"}),e.jsx("input",{type:"number",id:"customsCost",name:"customsCost",value:t.customsCost,onChange:m,min:"0",step:"0.01",className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"Description"}),e.jsx("textarea",{id:"description",name:"description",rows:3,value:t.description,onChange:m,className:"mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Notes..."})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-6",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 mb-4",children:"Add Products to Container"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"selectedProduct",className:"block text-sm font-medium text-gray-700 mb-1",children:"Select Product"}),e.jsxs("select",{id:"selectedProduct",value:i,onChange:s=>D(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"Choose a product..."}),b.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.category,")"]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bagQuantity",className:"block text-sm font-medium text-gray-700 mb-1",children:"Bags Quantity"}),e.jsx("input",{type:"number",id:"bagQuantity",name:"bagQuantity",value:l.bagQuantity,onChange:P,min:"1",step:"1",className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"costPerKg",className:"block text-sm font-medium text-gray-700 mb-1",children:"Cost per Kg ($)"}),e.jsx("input",{type:"number",id:"costPerKg",name:"costPerKg",value:l.costPerKg,onChange:P,min:"0",step:"0.0001",className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"0.0000"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bagWeight",className:"block text-sm font-medium text-gray-700 mb-1",children:"Bag Weight (kg)"}),e.jsxs("select",{id:"bagWeight",name:"bagWeight",value:l.bagWeight,onChange:P,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"20",children:"20 kg per bag"}),e.jsx("option",{value:"25",children:"25 kg per bag"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx("button",{type:"button",onClick:T,className:"inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500",children:"Add Product"}),e.jsx("button",{type:"button",onClick:()=>console.log("Current form state:",t),className:"inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:"Debug Form State"})]}),t.products.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h5",{className:"text-md font-medium text-gray-900 mb-3",children:"Products in Container:"}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[t.products.map((s,r)=>e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-gray-200 last:border-b-0",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-gray-900",children:s.productName}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.bagQuantity," bags × ",s.bagWeight,"kg × ",x(s.costPerKg,4),"/kg =",e.jsx("span",{className:"font-semibold text-gray-900 ml-1",children:x(s.bagQuantity*s.costPerKg*s.bagWeight)})]})]}),e.jsx("button",{type:"button",onClick:()=>U(s.productId),className:"ml-4 text-red-600 hover:text-red-800 p-1 rounded-md hover:bg-red-50",title:"Remove product",children:e.jsx(q,{className:"h-4 w-4"})})]},r)),e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-300",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Products Total:"}),e.jsx("span",{children:x(t.products.reduce((s,r)=>s+r.bagQuantity*r.costPerKg*r.bagWeight,0))})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Shipping Cost:"}),e.jsx("span",{children:x(t.shippingCost)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Customs/Clearing Cost:"}),e.jsx("span",{children:x(t.customsCost)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-semibold border-t border-gray-300 pt-2",children:[e.jsx("span",{children:"Total Container Cost:"}),e.jsx("span",{children:x(K())})]})]})]})]}),u.products&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:u.products})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-6 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:W,disabled:v,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:v,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:v?"Saving...":c?"Update Container":"Add Container"})]}),u.submit&&e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-sm text-red-600",children:u.submit})})]})]})})})}export{L as default};
