import{u as O,d as M,r as g,j as e,X as Q,f as R,e as z,b as C}from"./index-DPf7JDXQ.js";import{M as B}from"./Modal-CEl-WYAK.js";import{C as K}from"./calendar-CQJkPs1p.js";function J({sale:o,onClose:f}){const{products:u,addSale:_,deleteSale:D}=O(),{showSuccessMessage:I,showErrorMessage:E}=M(),[h,P]=g.useState(new Date().toISOString().split("T")[0]),[b,$]=g.useState(new Date().toTimeString().split(" ")[0].substring(0,5)),[d,j]=g.useState([{id:Date.now(),productId:"",quantity:"",pricePerUnit:"",notes:""}]),[n,v]=g.useState({}),[w,U]=g.useState(!1),y=u.filter(t=>t.currentStock>0),q=d.map(t=>t.productId).filter(t=>t);g.useEffect(()=>{o&&(P(o.date||new Date().toISOString().split("T")[0]),$(o.time||new Date().toTimeString().split(" ")[0].substring(0,5)),j([{id:Date.now(),productId:o.productId||"",quantity:o.quantity?.toString()||"",pricePerUnit:o.pricePerUnit?.toString()||"",notes:o.notes||""}]))},[o]);const c=(t,r,i)=>{j(a=>a.map(s=>{if(s.id===t){const l={...s,[r]:i};if(r==="productId"&&i){const x=u.find(p=>p.id===parseInt(i));x&&x.suggestedPrice&&!s.pricePerUnit&&(l.pricePerUnit=x.suggestedPrice.toString())}return l}return s})),n[`entry_${t}_${r}`]&&v(a=>{const s={...a};return delete s[`entry_${t}_${r}`],s})},T=()=>{j(t=>[...t,{id:Date.now(),productId:"",quantity:"",pricePerUnit:"",notes:""}])},k=t=>{d.length>1&&(j(r=>r.filter(i=>i.id!==t)),v(r=>{const i={...r};return Object.keys(i).forEach(a=>{a.includes(`entry_${t}_`)&&delete i[a]}),i}))},F=()=>{const t={};return h||(t.date="Date is required"),b||(t.time="Time is required"),d.forEach((r,i)=>{if(r.productId||(t[`entry_${r.id}_productId`]="Please select a product"),!r.quantity)t[`entry_${r.id}_quantity`]="Quantity is required";else{const a=parseInt(r.quantity);if(a<=0)t[`entry_${r.id}_quantity`]="Quantity must be greater than 0";else{const s=u.find(l=>l.id===parseInt(r.productId));s&&a>s.currentStock&&(t[`entry_${r.id}_quantity`]=`Only ${s.currentStock} units available`)}}r.pricePerUnit?parseFloat(r.pricePerUnit)<=0&&(t[`entry_${r.id}_pricePerUnit`]="Price must be > 0"):t[`entry_${r.id}_pricePerUnit`]="Price is required"}),v(t),Object.keys(t).length===0},A=async t=>{if(t.preventDefault(),!!F()){U(!0);try{if(o){const r={productId:parseInt(d[0].productId),quantity:parseInt(d[0].quantity),pricePerUnit:parseFloat(d[0].pricePerUnit),date:h,time:b,notes:d[0].notes.trim()};await D(o.id),await _(r),I("Sale Updated","Sale has been updated successfully")}else{const r=d.map(a=>({productId:parseInt(a.productId),quantity:parseInt(a.quantity),pricePerUnit:parseFloat(a.pricePerUnit),date:h,time:b,notes:a.notes.trim()}));for(const a of r)await _(a);const i=r.length===1?"Sale recorded successfully":`${r.length} sales recorded successfully`;I("Sales Recorded",i)}f()}catch(r){console.error("Sale submission error:",r),E("Sale Failed",r.message||"Failed to record sale(s)")}finally{U(!1)}}},m=(()=>{let t=0,r=0,i=0;return d.forEach(a=>{if(a.quantity&&a.pricePerUnit){const s=parseInt(a.quantity)||0,l=parseFloat(a.pricePerUnit)||0,x=s*l;t+=x,i+=s;const p=u.find(S=>S.id===parseInt(a.productId));if(p){const S=s*(p.costPerKg||p.costPerUnit||0)*(p.bagWeight||25);r+=x-S}}}),{totalAmount:t,totalProfit:r,totalQuantity:i}})(),N=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t||0);return e.jsx(B,{isOpen:!0,onClose:f,size:"xlarge",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl",children:[e.jsxs("div",{className:"flex items-start justify-between px-4 sm:px-6 py-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex-1 pr-2",children:[e.jsx("h3",{className:"text-lg sm:text-xl font-semibold text-gray-900",children:o?"Edit Sale":"Record Sales"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1 hidden sm:block",children:"Add multiple products for the same date and time"})]}),e.jsxs("button",{onClick:f,className:"text-gray-400 hover:text-gray-600 transition-colors p-1",children:[e.jsx("span",{className:"sr-only",children:"Close"}),e.jsx(Q,{className:"h-5 w-5 sm:h-6 sm:w-6"})]})]}),e.jsx("div",{className:"p-4 sm:p-6 max-h-[80vh] overflow-y-auto",children:e.jsxs("form",{onSubmit:A,className:"space-y-4 md:space-y-6",children:[e.jsx("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 sm:gap-6",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 mb-2",children:[e.jsx(K,{className:"h-4 w-4 text-gray-500"}),"Sale Date"]}),e.jsx("input",{type:"date",value:h,onChange:t=>P(t.target.value),className:`w-full px-3 py-3 sm:py-2 text-base sm:text-sm border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 ${n.date?"border-red-300 focus:border-red-500":"border-gray-300 focus:border-green-500"}`}),n.date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.date})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 mb-2",children:[e.jsx(R,{className:"h-4 w-4 text-gray-500"}),"Sale Time"]}),e.jsx("input",{type:"time",value:b,onChange:t=>$(t.target.value),className:`w-full px-3 py-3 sm:py-2 text-base sm:text-sm border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 ${n.time?"border-red-300 focus:border-red-500":"border-gray-300 focus:border-green-500"}`}),n.time&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.time})]})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-base sm:text-sm font-medium text-gray-700",children:"Sale Items"}),!o&&e.jsxs("button",{type:"button",onClick:T,className:"inline-flex items-center px-3 py-2 sm:py-1.5 text-sm font-medium text-green-700 bg-green-50 border border-green-300 rounded-md hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 touch-manipulation",children:[e.jsx(z,{className:"h-4 w-4 mr-1"}),"Add Item"]})]}),e.jsx("div",{className:"hidden md:block bg-gray-50 border border-gray-200 rounded-t-lg",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4 px-4 py-3 text-sm font-medium text-gray-700",children:[e.jsx("div",{className:"col-span-4",children:"Product"}),e.jsx("div",{className:"col-span-2",children:"Quantity"}),e.jsx("div",{className:"col-span-2",children:"Price/Unit"}),e.jsx("div",{className:"col-span-2",children:"Total"}),e.jsx("div",{className:"col-span-1",children:"Notes"}),e.jsx("div",{className:"col-span-1 text-center",children:"Action"})]})}),e.jsx("div",{className:"hidden md:block border border-t-0 border-gray-200 rounded-b-lg overflow-hidden",children:d.map((t,r)=>{const i=u.find(s=>s.id===parseInt(t.productId)),a=(parseInt(t.quantity)||0)*(parseFloat(t.pricePerUnit)||0);return e.jsxs("div",{className:`grid grid-cols-12 gap-4 px-4 py-3 ${r%2===0?"bg-white":"bg-gray-50"} border-b border-gray-100 last:border-b-0`,children:[e.jsxs("div",{className:"col-span-4",children:[e.jsxs("select",{value:t.productId,onChange:s=>c(t.id,"productId",s.target.value),className:`w-full px-2 py-1.5 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-green-500 ${n[`entry_${t.id}_productId`]?"border-red-300":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"Select product..."}),y.map(s=>{const l=q.includes(s.id.toString())&&s.id.toString()!==t.productId;return e.jsxs("option",{value:s.id,disabled:l,children:[s.name," (",s.category,") - Stock: ",s.currentStock,l&&" (Already selected)"]},s.id)})]}),n[`entry_${t.id}_productId`]&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:n[`entry_${t.id}_productId`]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("input",{type:"number",value:t.quantity,onChange:s=>c(t.id,"quantity",s.target.value),min:"1",step:"1",className:`w-full px-2 py-1.5 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-green-500 ${n[`entry_${t.id}_quantity`]?"border-red-300":"border-gray-300"}`,placeholder:"0"}),n[`entry_${t.id}_quantity`]&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:n[`entry_${t.id}_quantity`]}),i&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["Stock: ",i.currentStock]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("input",{type:"number",value:t.pricePerUnit,onChange:s=>c(t.id,"pricePerUnit",s.target.value),min:"0",step:"0.01",className:`w-full px-2 py-1.5 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-green-500 ${n[`entry_${t.id}_pricePerUnit`]?"border-red-300":"border-gray-300"}`,placeholder:"0.00"}),n[`entry_${t.id}_pricePerUnit`]&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:n[`entry_${t.id}_pricePerUnit`]})]}),e.jsx("div",{className:"col-span-2 flex items-center",children:e.jsx("span",{className:"text-sm font-medium text-gray-900",children:N(a)})}),e.jsx("div",{className:"col-span-1",children:e.jsx("input",{type:"text",value:t.notes,onChange:s=>c(t.id,"notes",s.target.value),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500",placeholder:"Notes..."})}),e.jsx("div",{className:"col-span-1 flex justify-center",children:!o&&d.length>1&&e.jsx("button",{type:"button",onClick:()=>k(t.id),className:"text-red-600 hover:text-red-800 transition-colors",children:e.jsx(C,{className:"h-4 w-4"})})})]},t.id)})}),e.jsx("div",{className:"md:hidden space-y-3",children:d.map((t,r)=>{const i=u.find(s=>s.id===parseInt(t.productId)),a=(parseInt(t.quantity)||0)*(parseFloat(t.pricePerUnit)||0);return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-500",children:["Item #",r+1]}),!o&&d.length>1&&e.jsx("button",{type:"button",onClick:()=>k(t.id),className:"text-red-600 hover:text-red-800 transition-colors p-1",children:e.jsx(C,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Product"}),e.jsxs("select",{value:t.productId,onChange:s=>c(t.id,"productId",s.target.value),className:`w-full px-3 py-2.5 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 ${n[`entry_${t.id}_productId`]?"border-red-300":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"Select product..."}),y.map(s=>{const l=q.includes(s.id.toString())&&s.id.toString()!==t.productId;return e.jsxs("option",{value:s.id,disabled:l,children:[s.name," - Stock: ",s.currentStock,l&&" (Already selected)"]},s.id)})]}),n[`entry_${t.id}_productId`]&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n[`entry_${t.id}_productId`]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quantity"}),e.jsx("input",{type:"number",value:t.quantity,onChange:s=>c(t.id,"quantity",s.target.value),min:"1",step:"1",inputMode:"numeric",className:`w-full px-3 py-2.5 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 ${n[`entry_${t.id}_quantity`]?"border-red-300":"border-gray-300"}`,placeholder:"0"}),n[`entry_${t.id}_quantity`]&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:n[`entry_${t.id}_quantity`]}),i&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["Stock: ",i.currentStock]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Price/Unit"}),e.jsx("input",{type:"number",value:t.pricePerUnit,onChange:s=>c(t.id,"pricePerUnit",s.target.value),min:"0",step:"0.01",inputMode:"decimal",className:`w-full px-3 py-2.5 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 ${n[`entry_${t.id}_pricePerUnit`]?"border-red-300":"border-gray-300"}`,placeholder:"0.00"}),n[`entry_${t.id}_pricePerUnit`]&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:n[`entry_${t.id}_pricePerUnit`]})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes (Optional)"}),e.jsx("input",{type:"text",value:t.notes,onChange:s=>c(t.id,"notes",s.target.value),className:"w-full px-3 py-2.5 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500",placeholder:"Add notes..."})]}),e.jsx("div",{className:"pt-3 border-t border-gray-100",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Item Total:"}),e.jsx("span",{className:"text-lg font-bold text-green-600",children:N(a)})]})})]},t.id)})}),y.length===0&&e.jsx("div",{className:"text-center py-4 text-sm text-orange-600",children:"No products with stock available. Add inventory first."})]}),m.totalAmount>0&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4 md:p-5 border border-green-200",children:[e.jsx("h4",{className:"text-base font-semibold text-green-900 mb-3",children:"Order Summary"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4",children:[e.jsxs("div",{className:"flex justify-between sm:block",children:[e.jsx("p",{className:"text-sm text-green-700",children:"Total Items"}),e.jsxs("div",{className:"text-right sm:text-left",children:[e.jsx("p",{className:"text-xl font-bold text-green-900",children:m.totalQuantity}),e.jsxs("p",{className:"text-xs text-green-600",children:[d.length," product",d.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex justify-between sm:block",children:[e.jsx("p",{className:"text-sm text-green-700",children:"Total Revenue"}),e.jsxs("div",{className:"text-right sm:text-left",children:[e.jsx("p",{className:"text-xl font-bold text-green-900",children:N(m.totalAmount)}),e.jsx("p",{className:"text-xs text-green-600",children:"Before expenses"})]})]}),e.jsxs("div",{className:"flex justify-between sm:block",children:[e.jsx("p",{className:"text-sm text-green-700",children:"Est. Profit"}),e.jsxs("div",{className:"text-right sm:text-left",children:[e.jsx("p",{className:`text-xl font-bold ${m.totalProfit>=0?"text-green-900":"text-red-600"}`,children:N(m.totalProfit)}),e.jsx("p",{className:"text-xs text-green-600",children:m.totalAmount>0?`${(m.totalProfit/m.totalAmount*100).toFixed(1)}% margin`:"0% margin"})]})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between items-stretch sm:items-center gap-3 pt-4 border-t border-gray-200",children:[e.jsx("div",{className:"text-sm text-gray-500 text-center sm:text-left",children:!o&&d.length>1&&e.jsxs("span",{className:"hidden sm:inline",children:["Recording ",d.length," sales for ",h]})}),e.jsxs("div",{className:"flex flex-col-reverse sm:flex-row gap-3 sm:space-x-0",children:[e.jsx("button",{type:"button",onClick:f,disabled:w,className:"w-full sm:w-auto px-5 py-3 sm:py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors touch-manipulation",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:w||y.length===0,className:"w-full sm:w-auto inline-flex justify-center items-center px-5 py-3 sm:py-2.5 text-sm font-medium text-white bg-gradient-to-r from-green-600 to-emerald-600 border border-transparent rounded-md shadow-sm hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all touch-manipulation",children:w?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"}),"Processing..."]}):e.jsx(e.Fragment,{children:o?"Update Sale":`Record ${d.length>1?d.length+" Sales":"Sale"}`})})]})]})]})})]})})}export{J as default};
