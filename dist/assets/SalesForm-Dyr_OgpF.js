import{u as A,d as O,r as x,j as e,X as R,e as M,b as Q}from"./index-bOp1r2QL.js";import{M as z}from"./Modal-CRPkkT7Z.js";import{C as B,a as K}from"./clock-DKqbEcyr.js";function J({sale:d,onClose:f}){const{products:p,addSale:P,deleteSale:q}=A(),{showSuccessMessage:I,showErrorMessage:D}=O(),[g,_]=x.useState(new Date().toISOString().split("T")[0]),[h,$]=x.useState(new Date().toTimeString().split(" ")[0].substring(0,5)),[i,b]=x.useState([{id:Date.now(),productId:"",quantity:"",pricePerUnit:"",notes:""}]),[o,y]=x.useState({}),[N,U]=x.useState(!1),v=p.filter(t=>t.currentStock>0),E=i.map(t=>t.productId).filter(t=>t);x.useEffect(()=>{d&&(_(d.date||new Date().toISOString().split("T")[0]),$(d.time||new Date().toTimeString().split(" ")[0].substring(0,5)),b([{id:Date.now(),productId:d.productId||"",quantity:d.quantity?.toString()||"",pricePerUnit:d.pricePerUnit?.toString()||"",notes:d.notes||""}]))},[d]);const j=(t,s,n)=>{b(a=>a.map(r=>{if(r.id===t){const c={...r,[s]:n};if(s==="productId"&&n){const u=p.find(m=>m.id===parseInt(n));u&&u.suggestedPrice&&!r.pricePerUnit&&(c.pricePerUnit=u.suggestedPrice.toString())}return c}return r})),o[`entry_${t}_${s}`]&&y(a=>{const r={...a};return delete r[`entry_${t}_${s}`],r})},C=()=>{b(t=>[...t,{id:Date.now(),productId:"",quantity:"",pricePerUnit:"",notes:""}])},k=t=>{i.length>1&&(b(s=>s.filter(n=>n.id!==t)),y(s=>{const n={...s};return Object.keys(n).forEach(a=>{a.includes(`entry_${t}_`)&&delete n[a]}),n}))},T=()=>{const t={};return g||(t.date="Date is required"),h||(t.time="Time is required"),i.forEach((s,n)=>{if(s.productId||(t[`entry_${s.id}_productId`]="Please select a product"),!s.quantity)t[`entry_${s.id}_quantity`]="Quantity is required";else{const a=parseInt(s.quantity);if(a<=0)t[`entry_${s.id}_quantity`]="Quantity must be greater than 0";else{const r=p.find(c=>c.id===parseInt(s.productId));r&&a>r.currentStock&&(t[`entry_${s.id}_quantity`]=`Only ${r.currentStock} units available`)}}s.pricePerUnit?parseFloat(s.pricePerUnit)<=0&&(t[`entry_${s.id}_pricePerUnit`]="Price must be > 0"):t[`entry_${s.id}_pricePerUnit`]="Price is required"}),y(t),Object.keys(t).length===0},F=async t=>{if(t.preventDefault(),!!T()){U(!0);try{if(d){const s={productId:parseInt(i[0].productId),quantity:parseInt(i[0].quantity),pricePerUnit:parseFloat(i[0].pricePerUnit),date:g,time:h,notes:i[0].notes.trim()};await q(d.id),await P(s),I("Sale Updated","Sale has been updated successfully")}else{const s=i.map(a=>({productId:parseInt(a.productId),quantity:parseInt(a.quantity),pricePerUnit:parseFloat(a.pricePerUnit),date:g,time:h,notes:a.notes.trim()}));for(const a of s)await P(a);const n=s.length===1?"Sale recorded successfully":`${s.length} sales recorded successfully`;I("Sales Recorded",n)}f()}catch(s){console.error("Sale submission error:",s),D("Sale Failed",s.message||"Failed to record sale(s)")}finally{U(!1)}}},l=(()=>{let t=0,s=0,n=0;return i.forEach(a=>{if(a.quantity&&a.pricePerUnit){const r=parseInt(a.quantity)||0,c=parseFloat(a.pricePerUnit)||0,u=r*c;t+=u,n+=r;const m=p.find(w=>w.id===parseInt(a.productId));if(m){const w=r*(m.costPerKg||m.costPerUnit||0)*(m.bagWeight||25);s+=u-w}}}),{totalAmount:t,totalProfit:s,totalQuantity:n}})(),S=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t||0);return e.jsx(z,{isOpen:!0,onClose:f,size:"xlarge",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900",children:d?"Edit Sale":"Record Multiple Sales"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Add multiple products for the same date and time"})]}),e.jsxs("button",{onClick:f,className:"text-gray-400 hover:text-gray-600 transition-colors",children:[e.jsx("span",{className:"sr-only",children:"Close"}),e.jsx(R,{className:"h-6 w-6"})]})]}),e.jsx("div",{className:"p-6",children:e.jsxs("form",{onSubmit:F,className:"space-y-6",children:[e.jsx("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 mb-2",children:[e.jsx(B,{className:"h-4 w-4 text-gray-500"}),"Sale Date"]}),e.jsx("input",{type:"date",value:g,onChange:t=>_(t.target.value),className:`w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 ${o.date?"border-red-300 focus:border-red-500":"border-gray-300 focus:border-green-500"}`}),o.date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.date})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 mb-2",children:[e.jsx(K,{className:"h-4 w-4 text-gray-500"}),"Sale Time"]}),e.jsx("input",{type:"time",value:h,onChange:t=>$(t.target.value),className:`w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 ${o.time?"border-red-300 focus:border-red-500":"border-gray-300 focus:border-green-500"}`}),o.time&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.time})]})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700",children:"Sale Items"}),!d&&e.jsxs("button",{type:"button",onClick:C,className:"inline-flex items-center px-3 py-1.5 text-sm font-medium text-green-700 bg-green-50 border border-green-300 rounded-md hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500",children:[e.jsx(M,{className:"h-4 w-4 mr-1"}),"Add Item"]})]}),e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-t-lg",children:e.jsxs("div",{className:"grid grid-cols-12 gap-4 px-4 py-3 text-sm font-medium text-gray-700",children:[e.jsx("div",{className:"col-span-4",children:"Product"}),e.jsx("div",{className:"col-span-2",children:"Quantity"}),e.jsx("div",{className:"col-span-2",children:"Price/Unit"}),e.jsx("div",{className:"col-span-2",children:"Total"}),e.jsx("div",{className:"col-span-1",children:"Notes"}),e.jsx("div",{className:"col-span-1 text-center",children:"Action"})]})}),e.jsx("div",{className:"border border-t-0 border-gray-200 rounded-b-lg overflow-hidden",children:i.map((t,s)=>{const n=p.find(r=>r.id===parseInt(t.productId)),a=(parseInt(t.quantity)||0)*(parseFloat(t.pricePerUnit)||0);return e.jsxs("div",{className:`grid grid-cols-12 gap-4 px-4 py-3 ${s%2===0?"bg-white":"bg-gray-50"} border-b border-gray-100 last:border-b-0`,children:[e.jsxs("div",{className:"col-span-4",children:[e.jsxs("select",{value:t.productId,onChange:r=>j(t.id,"productId",r.target.value),className:`w-full px-2 py-1.5 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-green-500 ${o[`entry_${t.id}_productId`]?"border-red-300":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"Select product..."}),v.map(r=>{const c=E.includes(r.id.toString())&&r.id.toString()!==t.productId;return e.jsxs("option",{value:r.id,disabled:c,children:[r.name," (",r.category,") - Stock: ",r.currentStock,c&&" (Already selected)"]},r.id)})]}),o[`entry_${t.id}_productId`]&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:o[`entry_${t.id}_productId`]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("input",{type:"number",value:t.quantity,onChange:r=>j(t.id,"quantity",r.target.value),min:"1",step:"1",className:`w-full px-2 py-1.5 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-green-500 ${o[`entry_${t.id}_quantity`]?"border-red-300":"border-gray-300"}`,placeholder:"0"}),o[`entry_${t.id}_quantity`]&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:o[`entry_${t.id}_quantity`]}),n&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["Stock: ",n.currentStock]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("input",{type:"number",value:t.pricePerUnit,onChange:r=>j(t.id,"pricePerUnit",r.target.value),min:"0",step:"0.01",className:`w-full px-2 py-1.5 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-green-500 ${o[`entry_${t.id}_pricePerUnit`]?"border-red-300":"border-gray-300"}`,placeholder:"0.00"}),o[`entry_${t.id}_pricePerUnit`]&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:o[`entry_${t.id}_pricePerUnit`]})]}),e.jsx("div",{className:"col-span-2 flex items-center",children:e.jsx("span",{className:"text-sm font-medium text-gray-900",children:S(a)})}),e.jsx("div",{className:"col-span-1",children:e.jsx("input",{type:"text",value:t.notes,onChange:r=>j(t.id,"notes",r.target.value),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500",placeholder:"Notes..."})}),e.jsx("div",{className:"col-span-1 flex justify-center",children:!d&&i.length>1&&e.jsx("button",{type:"button",onClick:()=>k(t.id),className:"text-red-600 hover:text-red-800 transition-colors",children:e.jsx(Q,{className:"h-4 w-4"})})})]},t.id)})}),v.length===0&&e.jsx("div",{className:"text-center py-4 text-sm text-orange-600",children:"No products with stock available. Add inventory first."})]}),l.totalAmount>0&&e.jsxs("div",{className:"bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-5 border border-green-200",children:[e.jsx("h4",{className:"text-base font-semibold text-green-900 mb-3",children:"Order Summary"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-700",children:"Total Items"}),e.jsx("p",{className:"text-xl font-bold text-green-900",children:l.totalQuantity}),e.jsxs("p",{className:"text-xs text-green-600",children:[i.length," product",i.length>1?"s":""]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-700",children:"Total Revenue"}),e.jsx("p",{className:"text-xl font-bold text-green-900",children:S(l.totalAmount)}),e.jsx("p",{className:"text-xs text-green-600",children:"Before expenses"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-700",children:"Estimated Profit"}),e.jsx("p",{className:`text-xl font-bold ${l.totalProfit>=0?"text-green-900":"text-red-600"}`,children:S(l.totalProfit)}),e.jsx("p",{className:"text-xs text-green-600",children:l.totalAmount>0?`${(l.totalProfit/l.totalAmount*100).toFixed(1)}% margin`:"0% margin"})]})]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t border-gray-200",children:[e.jsx("div",{className:"text-sm text-gray-500",children:!d&&i.length>1&&e.jsxs("span",{children:["Recording ",i.length," sales for ",g]})}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"button",onClick:f,disabled:N,className:"px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:N||v.length===0,className:"inline-flex items-center px-5 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-green-600 to-emerald-600 border border-transparent rounded-md shadow-sm hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all",children:N?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"}),"Processing..."]}):e.jsx(e.Fragment,{children:d?"Update Sale":`Record ${i.length>1?i.length+" Sales":"Sale"}`})})]})]})]})})]})})}export{J as default};
